#!/usr/bin/env python3
# akstaging/akamaistaging
"""
Akamai Staging Application.
This script serves as the main entry point for the Akamai Staging GUI application.
"""

import logging
import sys
from gi.repository import GLib, Gio

python_site_packages_path = "@PYTHON_SITE_PACKAGES@"
if python_site_packages_path not in sys.path:
    sys.path.insert(0, python_site_packages_path)

import gi

gi.require_version("Gdk", "4.0")
gi.require_version("Gtk", "4.0")
gi.require_version("Adw", "1")
from gi.repository import Adw, Gdk, Gtk

from akstaging.window import AkamaiStagingWindow

# This import will now work correctly
from akstaging.defs import SETTINGS_ID


class AkamaiApp(Adw.Application):
    """The main Adwaita Application class for Akamai Staging."""

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.window = None
        self.font_css_provider = None

        self.settings = Gio.Settings.new(SETTINGS_ID)
        self.settings.connect("changed::theme", lambda s, k: self.apply_theme())
        self.settings.connect(
            "changed::font-scale", lambda s, k: self.apply_font_scaling()
        )

    def do_startup(self):
        """Called when the application starts, before activate."""
        Adw.Application.do_startup(self)
        self.apply_theme()
        self.apply_font_scaling()

    def do_activate(self):
        """Handles the 'activate' signal of the Adw.Application."""
        if not self.window:
            self.window = AkamaiStagingWindow(application=self)
        self.window.present()

    def apply_theme(self):
        """Applies the color scheme based on the 'theme' GSettings key."""
        style_manager = self.get_style_manager()
        theme_str = self.settings.get_string("theme")

        match theme_str:
            case "dark":
                style_manager.set_color_scheme(Adw.ColorScheme.PREFER_DARK)
            case "light":
                style_manager.set_color_scheme(Adw.ColorScheme.PREFER_LIGHT)
            case _:  # "system" or any other fallback
                style_manager.set_color_scheme(Adw.ColorScheme.DEFAULT)

        logging.info("Applied theme: %s", theme_str)

    def apply_font_scaling(self, scale_factor=None):
        """Applies a font scaling factor to the entire application."""
        if scale_factor is None:
            scale_factor = self.settings.get_double("font-scale")

        logging.info("Applying font scale factor: %s", scale_factor)
        display = Gdk.Display.get_default()
        if display is None:
            logging.error("Cannot get GDK Display to apply font scaling.")
            return

        if self.font_css_provider is not None:
            Gtk.StyleContext.remove_provider_for_display(
                display, self.font_css_provider
            )
            self.font_css_provider = None

        if abs(scale_factor - 1.0) > 0.01:
            self.font_css_provider = Gtk.CssProvider()
            css_data = f"* {{ font-size: {scale_factor}rem; }}".encode()
            self.font_css_provider.load_from_data(css_data)
            Gtk.StyleContext.add_provider_for_display(
                display, self.font_css_provider, Gtk.STYLE_PROVIDER_PRIORITY_USER
            )


if __name__ == "__main__":
    logging.basicConfig(level=logging.WARN, format="%(levelname)s:%(name)s:%(message)s")

    app = AkamaiApp(application_id="com.github.mclellac.AkamaiStaging")
    exit_status = app.run(sys.argv)
    sys.exit(exit_status)
